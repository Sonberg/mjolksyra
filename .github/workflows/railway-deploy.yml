name: Railway Deploy (Preview + Production)

on:
  pull_request:
    branches: [main]
    paths:
      - "mjolksyra-app/**"
      - "mjolksyra-api/**"
      - ".github/workflows/railway-deploy.yml"
  push:
    branches: [main]
    paths:
      - "mjolksyra-app/**"
      - "mjolksyra-api/**"
      - ".github/workflows/railway-deploy.yml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy-preview:
    name: Deploy Preview
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: railway-preview
    concurrency:
      group: railway-preview-${{ github.event.pull_request.number || github.ref_name }}
      cancel-in-progress: true
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_PROJECT_ID: ${{ vars.RAILWAY_PROJECT_ID }}
      RAILWAY_ENVIRONMENT_NAME: ${{ vars.RAILWAY_PREVIEW_ENVIRONMENT_NAME }}
      RAILWAY_API_SERVICE_ID: ${{ vars.RAILWAY_API_SERVICE_ID }}
      RAILWAY_APP_SERVICE_ID: ${{ vars.RAILWAY_APP_SERVICE_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Deploy API (preview)
        working-directory: ${{ github.workspace }}/mjolksyra-api
        run: |
          railway link --project "$RAILWAY_PROJECT_ID" --environment "$RAILWAY_ENVIRONMENT_NAME" --service "$RAILWAY_API_SERVICE_ID"
          railway up --ci

      - name: Deploy App (preview)
        working-directory: ${{ github.workspace }}/mjolksyra-app
        run: |
          railway link --project "$RAILWAY_PROJECT_ID" --environment "$RAILWAY_ENVIRONMENT_NAME" --service "$RAILWAY_APP_SERVICE_ID"
          railway up --ci

  deploy-production:
    name: Deploy Production
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: railway-production
    concurrency:
      group: railway-production
      cancel-in-progress: false
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_PROJECT_ID: ${{ vars.RAILWAY_PROJECT_ID }}
      RAILWAY_ENVIRONMENT_NAME: ${{ vars.RAILWAY_PRODUCTION_ENVIRONMENT_NAME }}
      RAILWAY_API_SERVICE_ID: ${{ vars.RAILWAY_API_SERVICE_ID }}
      RAILWAY_APP_SERVICE_ID: ${{ vars.RAILWAY_APP_SERVICE_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Deploy API (production)
        working-directory: ${{ github.workspace }}/mjolksyra-api
        run: |
          railway link --project "$RAILWAY_PROJECT_ID" --environment "$RAILWAY_ENVIRONMENT_NAME" --service "$RAILWAY_API_SERVICE_ID"
          railway up --ci

      - name: Deploy App (production)
        working-directory: ${{ github.workspace }}/mjolksyra-app
        run: |
          railway link --project "$RAILWAY_PROJECT_ID" --environment "$RAILWAY_ENVIRONMENT_NAME" --service "$RAILWAY_APP_SERVICE_ID"
          railway up --ci
